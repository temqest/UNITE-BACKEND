[dotenv@17.2.3] injecting env (24) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
[1mΓòöΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòù[0m
[1mΓòæ         RESCHEDULE WORKFLOW TEST: Stakeholder ΓåÆ Coordinator Accept        Γòæ[0m
[1mΓòÜΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓòÉΓò¥[0m
[32mΓ£ô Connected to MongoDB (Database: unite_bmc_production)[0m

================================================================================
[1mINITIAL STATE[0m
================================================================================

{
  "requestId": "REQ-1769417291951-3940",
  "status": "review-rescheduled",
  "activeResponder": {
    "userId": "697711a3dbbebe7c7c6cb7a8",
    "relationship": "reviewer",
    "authority": null
  },
  "lastAction": {
    "action": "reschedule",
    "actorId": "697184d66d0127f028ac2ee4",
    "timestamp": "2026-01-26T14:57:11.919Z"
  },
  "validCoordinators": [
    {
      "userId": "6970448c6d0127f028ab5474",
      "name": "Ben Carlo Valiente"
    },
    {
      "userId": "6970784d6d0127f028ab85c6",
      "name": "David Jaque"
    },
    {
      "userId": "697711a3dbbebe7c7c6cb7a8",
      "name": "UNITE Dev"
    },
    {
      "userId": "69771226dbbebe7c7c6cc1dc",
      "name": "UNITE Dis 2 Dev"
    },
    {
      "userId": "696088303f2b9335d7bcadce",
      "name": "Admin User"
    }
  ],
  "reviewer": {
    "userId": "697711a3dbbebe7c7c6cb7a8",
    "name": "UNITE Dev"
  },
  "requester": {
    "userId": "697184d66d0127f028ac2ee4",
    "name": "testing cam sur 2"
  }
}

================================================================================
[1mSTEP 1: Stakeholder Proposes Reschedule[0m
================================================================================

[33mΓåÆ Fetching current request state[0m
Current status: review-rescheduled
Last action: reschedule by 697184d66d0127f028ac2ee4
Active responder: reviewer (697711a3dbbebe7c7c6cb7a8)
[33m
ΓÜá Warning: Request is not in 'approved' state. Current state: review-rescheduled[0m
[33mTest will continue but reschedule may fail...[0m
[33m
ΓåÆ Simulating reschedule action (updating request manually)[0m
[33m
ΓåÆ Calling requestStateService.getActiveResponder()[0m
Active Responder Result: {
  userId: new ObjectId('697711a3dbbebe7c7c6cb7a8'),
  relationship: 'reviewer',
  authority: null
}
[32m
Γ£ô Request updated to review-rescheduled state[0m
New status: review-rescheduled
Active responder: reviewer
Active responder userId: 697711a3dbbebe7c7c6cb7a8

================================================================================
[1mSTEP 2: Check Available Actions for All Users[0m
================================================================================


------------------------------------------------------------
[36mChecking available actions for: Admin User (admin)[0m
------------------------------------------------------------
User ID: 696088303f2b9335d7bcadce
Authority: 100
[33m
ΓåÆ Calling actionValidatorService.getAvailableActions()[0m
  Parameters: {
  userId: '696088303f2b9335d7bcadce',
  requestId: 'REQ-1769417291951-3940',
  status: 'review-rescheduled',
  locationId: '6960871e3f2b9335d7bc99bb'
}
[TEST] About to call actionValidatorService.getAvailableActions...
[TEST] Service type: object
[TEST] getAvailableActions type: function
[ACTION VALIDATOR] getAvailableActions - START {
  requestId: 'REQ-1769417291951-3940',
  userId: '696088303f2b9335d7bcadce',
  state: 'review-rescheduled',
  normalizedState: 'review-rescheduled',
  validCoordinatorsCount: 5
}
[ACTION VALIDATOR] Admin (696088303f2b9335d7bcadce, authority 100) allowed as secondary reviewer for SΓåÆC reschedule REQ-1769417291951-3940
[ACTION VALIDATOR] Before shouldProceed check {
  requestId: 'REQ-1769417291951-3940',
  userId: '696088303f2b9335d7bcadce',
  isActiveResponder: true,
  shouldProceed: true,
  normalizedState: 'review-rescheduled'
}
[TEST] Got result: [ 'view' ]
[32m
Γ£ô Available Actions Result:[0m
  Actions: [view]
[33m
ΓåÆ Testing individual action validation:[0m
[31m  Γ£ù accept: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reject: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reschedule: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù view: DENIED[0m
    Reason: Action 'view' is not valid for request in state 'review-rescheduled'

------------------------------------------------------------
[36mChecking available actions for: testing cam sur 2 (stakeholder)[0m
------------------------------------------------------------
User ID: 697184d66d0127f028ac2ee4
Authority: 30
[33m
ΓåÆ Calling actionValidatorService.getAvailableActions()[0m
  Parameters: {
  userId: '697184d66d0127f028ac2ee4',
  requestId: 'REQ-1769417291951-3940',
  status: 'review-rescheduled',
  locationId: '6960871e3f2b9335d7bc99bb'
}
[TEST] About to call actionValidatorService.getAvailableActions...
[TEST] Service type: object
[TEST] getAvailableActions type: function
[ACTION VALIDATOR] getAvailableActions - START {
  requestId: 'REQ-1769417291951-3940',
  userId: '697184d66d0127f028ac2ee4',
  state: 'review-rescheduled',
  normalizedState: 'review-rescheduled',
  validCoordinatorsCount: 5
}
[ACTION VALIDATOR] Valid coordinator check {
  requestId: 'REQ-1769417291951-3940',
  userId: '697184d66d0127f028ac2ee4',
  isValidCoordinator: false,
  state: 'review-rescheduled',
  validCoordinators: [
    '6970448c6d0127f028ab5474',
    '6970784d6d0127f028ab85c6',
    '697711a3dbbebe7c7c6cb7a8',
    '69771226dbbebe7c7c6cc1dc',
    '696088303f2b9335d7bcadce'
  ]
}
[ACTION VALIDATOR] Before shouldProceed check {
  requestId: 'REQ-1769417291951-3940',
  userId: '697184d66d0127f028ac2ee4',
  isActiveResponder: false,
  shouldProceed: false,
  normalizedState: 'review-rescheduled'
}
[ACTION VALIDATOR] Returning early - NOT proceeding (only view) {
  requestId: 'REQ-1769417291951-3940',
  userId: '697184d66d0127f028ac2ee4',
  shouldProceed: false
}
[TEST] Got result: [ 'view' ]
[32m
Γ£ô Available Actions Result:[0m
  Actions: [view]
[33m
ΓåÆ Testing individual action validation:[0m
[31m  Γ£ù accept: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reject: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reschedule: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù view: DENIED[0m
    Reason: Action 'view' is not valid for request in state 'review-rescheduled'

------------------------------------------------------------
[36mChecking available actions for: UNITE Dev (assignedCoord)[0m
------------------------------------------------------------
User ID: 697711a3dbbebe7c7c6cb7a8
Authority: 60
[33m
ΓåÆ Calling actionValidatorService.getAvailableActions()[0m
  Parameters: {
  userId: '697711a3dbbebe7c7c6cb7a8',
  requestId: 'REQ-1769417291951-3940',
  status: 'review-rescheduled',
  locationId: '6960871e3f2b9335d7bc99bb'
}
[TEST] About to call actionValidatorService.getAvailableActions...
[TEST] Service type: object
[TEST] getAvailableActions type: function
[ACTION VALIDATOR] getAvailableActions - START {
  requestId: 'REQ-1769417291951-3940',
  userId: '697711a3dbbebe7c7c6cb7a8',
  state: 'review-rescheduled',
  normalizedState: 'review-rescheduled',
  validCoordinatorsCount: 5
}
[ACTION VALIDATOR] Before shouldProceed check {
  requestId: 'REQ-1769417291951-3940',
  userId: '697711a3dbbebe7c7c6cb7a8',
  isActiveResponder: true,
  shouldProceed: true,
  normalizedState: 'review-rescheduled'
}
[TEST] Got result: [ 'view', 'accept', 'reject', 'reschedule' ]
[32m
Γ£ô Available Actions Result:[0m
  Actions: [view, accept, reject, reschedule]
[33m
ΓåÆ Testing individual action validation:[0m
[31m  Γ£ù accept: DENIED[0m
    Reason: Unknown
[31m  Γ£ù reject: DENIED[0m
    Reason: Unknown
[31m  Γ£ù reschedule: DENIED[0m
    Reason: Unknown
[31m  Γ£ù view: DENIED[0m
    Reason: Action 'view' is not valid for request in state 'review-rescheduled'

------------------------------------------------------------
[36mChecking available actions for: UNITE Dis 2 Dev (validCoord)[0m
------------------------------------------------------------
User ID: 69771226dbbebe7c7c6cc1dc
Authority: 60
[33m
ΓåÆ Calling actionValidatorService.getAvailableActions()[0m
  Parameters: {
  userId: '69771226dbbebe7c7c6cc1dc',
  requestId: 'REQ-1769417291951-3940',
  status: 'review-rescheduled',
  locationId: '6960871e3f2b9335d7bc99bb'
}
[TEST] About to call actionValidatorService.getAvailableActions...
[TEST] Service type: object
[TEST] getAvailableActions type: function
[ACTION VALIDATOR] getAvailableActions - START {
  requestId: 'REQ-1769417291951-3940',
  userId: '69771226dbbebe7c7c6cc1dc',
  state: 'review-rescheduled',
  normalizedState: 'review-rescheduled',
  validCoordinatorsCount: 5
}
[ACTION VALIDATOR] Valid coordinator check {
  requestId: 'REQ-1769417291951-3940',
  userId: '69771226dbbebe7c7c6cc1dc',
  isValidCoordinator: true,
  state: 'review-rescheduled',
  validCoordinators: [
    '6970448c6d0127f028ab5474',
    '6970784d6d0127f028ab85c6',
    '697711a3dbbebe7c7c6cb7a8',
    '69771226dbbebe7c7c6cc1dc',
    '696088303f2b9335d7bcadce'
  ]
}
[ACTION VALIDATOR] Valid coordinator (69771226dbbebe7c7c6cc1dc) allowed to act on broadcast request REQ-1769417291951-3940 in review-rescheduled state
[ACTION VALIDATOR] Before shouldProceed check {
  requestId: 'REQ-1769417291951-3940',
  userId: '69771226dbbebe7c7c6cc1dc',
  isActiveResponder: true,
  shouldProceed: true,
  normalizedState: 'review-rescheduled'
}
[TEST] Got result: [ 'view' ]
[32m
Γ£ô Available Actions Result:[0m
  Actions: [view]
[33m
ΓåÆ Testing individual action validation:[0m
[31m  Γ£ù accept: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reject: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù reschedule: DENIED[0m
    Reason: Only the active responder can perform actions on this request
[31m  Γ£ù view: DENIED[0m
    Reason: Action 'view' is not valid for request in state 'review-rescheduled'

================================================================================
[1mSTEP 3: Analyze Broadcast Model[0m
================================================================================

[36mValid Coordinators List:[0m
  1. Ben Carlo Valiente - 6970448c6d0127f028ab5474 
  2. David Jaque - 6970784d6d0127f028ab85c6 
  3. UNITE Dev - 697711a3dbbebe7c7c6cb7a8 (ASSIGNED)
  4. UNITE Dis 2 Dev - 69771226dbbebe7c7c6cc1dc 
  5. Admin User - 696088303f2b9335d7bcadce 
[36m
Assigned Reviewer:[0m
  UNITE Dev - 697711a3dbbebe7c7c6cb7a8
[36m
Requester:[0m
  testing cam sur 2 - 697184d66d0127f028ac2ee4
[36m
Active Responder:[0m
  Relationship: reviewer
  User ID: 697711a3dbbebe7c7c6cb7a8
  Authority: none
[36m
Last Action:[0m
  Action: reschedule
  Actor ID: 697184d66d0127f028ac2ee4
  Timestamp: Mon Jan 26 2026 22:57:42 GMT+0800 (Philippine Standard Time)

================================================================================
[1mSUMMARY: Available Actions by User[0m
================================================================================

Expected Behavior:
  ΓÇó Stakeholder (requester): Should see only "view" (not active responder)
  ΓÇó Assigned Coordinator: Should see accept, reject, reschedule
  ΓÇó Valid Coordinator (non-assigned): Should see accept, reject, reschedule (BROADCAST)
  ΓÇó Admin: Should see accept, reject, reschedule (BROADCAST)

[1mActual Results:[0m

Admin User (admin):
  Authority: 100
  Actions: [view]
[31m  Γ£ù admin: Missing review actions - only has [view][0m

testing cam sur 2 (stakeholder):
  Authority: 30
  Actions: [view]
[32m  Γ£ô Correct: Only has view access[0m

UNITE Dev (assignedCoord):
  Authority: 60
  Actions: [view, accept, reject, reschedule]
[32m  Γ£ô Correct: Has all review actions (accept, reject, reschedule)[0m

UNITE Dis 2 Dev (validCoord):
  Authority: 60
  Actions: [view]
[31m  Γ£ù validCoord: Missing review actions - only has [view][0m
[33m
ΓÜá ISSUES FOUND:[0m
  1. admin: Missing review actions - only has [view]
  2. validCoord: Missing review actions - only has [view]

================================================================================
[1mFINAL STATE[0m
================================================================================

{
  "requestId": "REQ-1769417291951-3940",
  "status": "review-rescheduled",
  "activeResponder": {
    "userId": "697711a3dbbebe7c7c6cb7a8",
    "relationship": "reviewer",
    "authority": null
  },
  "lastAction": {
    "action": "reschedule",
    "actorId": "697184d66d0127f028ac2ee4",
    "timestamp": "2026-01-26T14:57:42.110Z"
  },
  "validCoordinators": [
    {
      "userId": "6970448c6d0127f028ab5474",
      "name": "Ben Carlo Valiente"
    },
    {
      "userId": "6970784d6d0127f028ab85c6",
      "name": "David Jaque"
    },
    {
      "userId": "697711a3dbbebe7c7c6cb7a8",
      "name": "UNITE Dev"
    },
    {
      "userId": "69771226dbbebe7c7c6cc1dc",
      "name": "UNITE Dis 2 Dev"
    },
    {
      "userId": "696088303f2b9335d7bcadce",
      "name": "Admin User"
    }
  ],
  "reviewer": {
    "userId": "697711a3dbbebe7c7c6cb7a8",
    "name": "UNITE Dev"
  },
  "requester": {
    "userId": "697184d66d0127f028ac2ee4",
    "name": "testing cam sur 2"
  }
}
[32m
Γ£ô Test completed[0m
[33m
ΓÜá Found 2 issue(s) - see summary above[0m
